# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Rust library integrating **C2PA** (content provenance) with **OpenTDF** (attribute-based encryption). Produces both a Rust `rlib` and a C `staticlib` for Swift/XCFramework consumption. The C header (`include/c2pa_opentdf.h`) is auto-generated by `cbindgen` at build time via `build.rs`.

## Build and Test Commands

```bash
cargo build                        # Build (also regenerates C header)
cargo test                         # Run all 12 offline tests + 3 unit tests
cargo test <test_name>             # Run a specific test
cargo test -- --ignored            # Run server-dependent tests (require https://100.arkavo.net)
cargo test -- --nocapture          # Tests with stdout
cargo clippy -- -D warnings        # Lint
cargo fmt --check                  # Check formatting (CI enforces this)
cargo build --features kas         # Build with KAS decrypt support
./build-xcframework.sh             # Build XCFramework for macOS/iOS/iOS-sim (aarch64)
```

## Architecture

### Two Layers

1. **Rust API** (`src/signer.rs`) — `C2paOpenTdf` struct with builder pattern. Sign-then-encrypt workflow:
   - C2PA signs media files (must have proper file extension: .png, .jpg, etc.)
   - OpenTDF encrypts the signed output with AES-256-GCM segmented encryption
   - `decrypt_and_verify` (behind `kas` feature flag) reverses the process

2. **C FFI** (`src/ffi.rs`) — Four `extern "C"` functions for Swift consumers:
   - `c2pa_sign_file` — sign a media file with C2PA manifest
   - `c2pa_verify_file` — verify and return structured JSON result
   - `c2pa_info_file` — extract raw manifest JSON
   - `c2pa_string_free` — free any string allocated by the above functions
   - All functions return `C2paResultCode` enum and write errors to `*error_out`
   - Caller must free all out-strings via `c2pa_string_free`

### Error Handling

- Rust API: `C2paOpenTdfError` in `src/error.rs` with `thiserror`, aliased as `Result<T>`
- FFI layer: `C2paResultCode` C enum (0=Success through 5=InternalError), panics caught via `catch_unwind`

### Key Constraints

- C2PA requires supported media types — plain binary won't work
- Temp files need proper extensions (`.png`, `.jpg`) or C2PA throws "type is unsupported"
- C2PA won't overwrite existing files — must `remove_file` first
- Custom assertions use `org.arkavo.*` namespace
- OpenTDF dependency comes from git tag at `github.com/arkavo-org/opentdf-rs`

### CI/CD

- `.github/workflows/feature.yaml` — PR checks: fmt, clippy, test (macos-latest)
- `.github/workflows/release.yaml` — On push to main: test, build XCFramework, create GitHub Release with `C2paOpenTDF.xcframework.zip` + `c2pa_opentdf.h`
- Version extracted from `Cargo.toml`; release is skipped if tag already exists

### Test Data

Test certificates (`tests/data/cert.pem`, `tests/data/private.pem`) are self-signed ES256 from the c2pa-rs test fixtures. `tests/data/logo.png` is the sample media file for all tests.
